<?xml version="1.0" encoding="UTF-8"?>
<!--
  Endpoint groups referenced by the policy below.
  NOTE: Addresses use RFC 5737 TEST-NET prefixes as placeholders.
-->
<endpoint-groups xmlns="urn:ietf:params:xml:ns:yang:ietf-i2nsf-cons-facing-interface">
  <!-- User groups: management/admins (exempt) and non-critical traffic to be throttled -->
  <user-group>
    <name>management-admins</name>
    <ipv4-prefix>203.0.113.0/25</ipv4-prefix>
  </user-group>

  <user-group>
    <name>non-critical-traffic</name>
    <ipv4-prefix>203.0.113.128/25</ipv4-prefix>
  </user-group>

  <!-- Device groups: primary and standby firewall devices -->
  <device-group>
    <name>firewall-primary</name>
    <ipv4-prefix>192.0.2.0/28</ipv4-prefix>
  </device-group>

  <device-group>
    <name>firewall-standby</name>
    <ipv4-prefix>198.51.100.0/28</ipv4-prefix>
  </device-group>
</endpoint-groups>

<i2nsf-cfi-policy xmlns="urn:ietf:params:xml:ns:yang:ietf-i2nsf-cons-facing-interface">
  <name>Firewall_CPU_Overload_Response</name>
  <language>en-US</language>
  <priority-usage>priority-by-order</priority-usage>
  <resolution-strategy>fmr</resolution-strategy>

  <!--
    Rule 1: Exempt critical/management traffic from mitigation (must appear first when using priority-by-order).
    This prevents the subsequent throttling rule from affecting management/admin traffic.
  -->
  <rules>
    <name>Exempt_Management_Traffic_From_Throttling</name>
    <condition>
      <firewall>
        <!-- Event pertains to the primary firewall device -->
        <source>firewall-primary</source>
        <!-- Exempt traffic destined to management-admins -->
        <destination>management-admins</destination>
      </firewall>
    </condition>
    <action>
      <primary-action>
        <action>pass</action>
      </primary-action>
    </action>
  </rules>

  <!--
    Rule 2: Notify administrators and request orchestrator to initiate failover & other remediation.
    NOTE: The YANG model's native actions do not include direct 'notify' or 'failover' primitives;
    'invoke-signaling' is used to call an external orchestrator that performs notification and failover
    (including any pre-checks such as standby health/config sync). The external orchestrator should
    only act if it verifies failover prerequisites.
  -->
  <rules>
    <name>High_CPU_Notify_And_Mitigate</name>
    <condition>
      <firewall>
        <source>firewall-primary</source>
      </firewall>
      <!--
        NOTE: The numeric threshold (e.g., CPU > 90%) and "sustained for N seconds" semantics are
        not expressible in the provided YANG excerpt for system-alarm. This policy expects an
        external monitor/orchestrator to assert the cpu-alarm event only after the threshold and
        persistence criteria have been verified (e.g., CPU > 90% for 30s).
      -->
    </condition>
    <action>
      <primary-action>
        <action>invoke-signaling</action>
      </primary-action>
    </action>
  </rules>

  <!--
    Rule 3: Throttle / deprioritize non-critical traffic when the primary firewall reports cpu-alarm.
    Uses rate-limit action. Limit unit is bytes per second. Example here: 10 Mbps == 1,250,000 bytes/sec.
    This rule executes after the exempt rule and after the invoke-signaling rule (priority-by-order).
  -->
  <rules>
    <name>High_CPU_Throttle_NonCritical</name>
    <condition>
      <firewall>
        <source>firewall-primary</source>
        <!-- Apply throttling to the non-critical traffic endpoint group -->
        <destination>non-critical-traffic</destination>
      </firewall>
    </condition>
    <action>
      <primary-action>
        <action>rate-limit</action>
        <!-- 10 Mbps = 10,000,000 bits/s = 1,250,000 bytes/s -->
        <limit>1250000</limit>
      </primary-action>
    </action>
  </rules>

  <!--
    Notes and operational expectations (not expressible directly in the model):
    - Threshold/duration (CPU > 90% sustained) must be enforced by the monitoring/orchestration layer
      which asserts the 'cpu-alarm' event into the NSF only after verification (e.g., 90% for 30s).
    - The 'invoke-signaling' action is expected to carry or trigger an orchestration workflow that:
        * Notifies management-admins (e.g., email/SMS/IM) and includes event details (device id, CPU%, duration, actions taken).
        * Performs failover to firewall-standby after verifying prerequisites (standby exists, healthy, config sync OK).
        * Initiates any additional mitigations or escalations.
    - Rollback/failback and anti-flapping (cooldown) behavior should be handled by the orchestrator (e.g.,
      require sustained CPU < threshold for Z minutes before reverting throttles/failback, and prevent repeated
      automated failovers within a cooldown window).
    - Logging destinations and formats (e.g., SIEM endpoint, syslog server, severity) are configured outside
      this policy or via model augmentations; this policy requests rule-log entries for observability.
  -->
</i2nsf-cfi-policy>
